<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Setup :: Template Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/eap-on-openshift/08-observability.html">
    <link rel="prev" href="07-content-trimming.html">
    <link rel="next" href="09-whats-next.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/course-template">Template Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="eap-on-openshift" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-overview.html">Overview of JBoss EAP on OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#benefits">Benefits of running JBoss EAP on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#cloud-native">Cloud native development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#modernization">Modernization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#build">Building for OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#deployment">Deploying on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#clustering">Clustering JBoss EAP applications on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#autoscaling">Autoscaling applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#graceful-shutdown">Graceful shutdown</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#https">HTTPS configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#platform-options">OpenShift platform options</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pre-reqs.html">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-mta.html">Migration Toolkit for Applications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-mta.html#installation">Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-mta.html#cloud-readiness">Perform cloud readiness check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-mta.html#the-report">Understanding the report</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-build-with-helm.html">Building JBoss EAP images with Helm</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#prereqs">Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#connectdb">Configuring JBoss EAP to connect to the postgres database</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#build">Building JBoss EAP images with Helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#chained-builds">S2I chained builds</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#deploy">Application deployment with helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#testing">Testing the application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-deploy-with-operator.html">Deploying applications with the JBoss EAP Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-deploy-with-operator.html#install">Installing the JBoss EAP Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-deploy-with-operator.html#deploy">Deploy JBoss EAP application with the operator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-intro-to-EAP-xp.html">Introduction to JBoss EAP XP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-intro-to-EAP-xp.html#xponopenshift">Deploying JBoss EAP XP applications on OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-adding-microprofile.html">Adding MicroProfile support with JBoss EAP XP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-adding-microprofile.html#health">Adding a MicroProfile health check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-adding-microprofile.html#build">Building a MicroProfile application image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-adding-microprofile.html#testing">Testing MicroProfile health implementation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-content-trimming.html">Using capability trimming to reduce image size</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-content-trimming.html#implement">Implement capability trimming</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-observability.html">Observability and Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#prometheus">Deploy prometheus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#custom">Custom metrics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-whats-next.html">What&#8217;s next</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Re-platform JBoss EAP on OpenShift</a></li>
    <li><a href="08-observability.html">Observability and Monitoring</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/deewhyweb/replatform-jboss-eap-openshift/edit/master/documentation/modules/ROOT/pages/08-observability.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Setup</h1>
<div class="sect1">
<h2 id="_observability_and_monitoring"><a class="anchor" href="#_observability_and_monitoring"></a>Observability and Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we&#8217;re going to look at how to integrate our application with OpenShift observability tools, e.g. prometheus.</p>
</div>
<div class="paragraph">
<p>The first step is to install the prometheus operator into the same namespace as our JBoss EAP application ("eap").  To do this, login to the administrator-ui and go to "OperatorHub".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prometheus"><a class="anchor" href="#prometheus"></a>Deploy prometheus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Operator hub, filter for prometheus;</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-operator.png" alt="prometheus operator">
</div>
</div>
<div class="paragraph">
<p>Click on "Prometheus Operator".  You will be prompted with a community message, click on continue:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/community-warning.png" alt="community warning">
</div>
</div>
<div class="paragraph">
<p>From the next screen, click on "Install"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-operator-install.png" alt="prometheus operator install">
</div>
</div>
<div class="paragraph">
<p>On the main installation page, ensure "eap" is selected as the "Installed namespace" and click on "Install"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/promeetheus-namespace.png" alt="promeetheus namespace">
</div>
</div>
<div class="paragraph">
<p>Once the installation has finished, you will be prompted with:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-install-done.png" alt="prometheus install done">
</div>
</div>
<div class="paragraph">
<p>Click on "View operator" to go to the main Prometheus operator page.</p>
</div>
<div class="paragraph">
<p>From this page you can deploy an instance of prometheus, but also deploy other prometheus custom resources.  For example, the service monitor custom resource will configure a deployed prometheus instance to pull metrics from specified services.</p>
</div>
<div class="paragraph">
<p>Switch to the "Service Monitor" tab.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/service-monitor.png" alt="service monitor">
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice a service monitor object already exists called "example".  Clicking on this will reveal the contents of the object.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/service-monitor-detail.png" alt="service monitor detail">
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice this service monitor has the following labels:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    app.kubernetes.io/managed-by: eap-operator
    app.kubernetes.io/name: example
    app.openshift.io/runtime: eap</code></pre>
</div>
</div>
<div class="paragraph">
<p>This record was created by the JBoss EAP operator when our JBoss EAP application was deployed.  Once we deploy an instance of promethues this object will automatically configure prometheus to pull metrics from our running EAP instance.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go ahead and deploy an instance of prometheus.  Navigate to the "Prometheus" tab.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-instance.png" alt="prometheus instance">
</div>
</div>
<div class="paragraph">
<p>Click on "Create Prometheus"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/create-prometheus.png" alt="create prometheus">
</div>
</div>
<div class="paragraph">
<p>Leave the defaults unchanged and click on "Create"</p>
</div>
<div class="paragraph">
<p>Once the prometheus pods are running we can access our prometheus ui using port forwarding.  At the command line enter the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc port-forward -n eap svc/prometheus-operated 9090</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using your browser, navigate to <a href="http://127.0.0.1:9090/" class="bare">http://127.0.0.1:9090/</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-landing.png" alt="prometheus landing">
</div>
</div>
<div class="paragraph">
<p>Enter "base_memory_usedHeap_bytes" in the search box and click on "graph"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-graph.png" alt="prometheus graph">
</div>
</div>
<div class="paragraph">
<p>Yuo can see from this graph prometheus is now collecting metrics from our EAP instance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom"><a class="anchor" href="#custom"></a>Custom metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have prometheus deployed and receiving metrics from our EAP instance, we can add custom metrics to report application specific data.</p>
</div>
<div class="paragraph">
<p>With Microprofile it&#8217;s very easy to do this.</p>
</div>
<div class="paragraph">
<p>In the source code for our application we add the following to our pom.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">        &lt;dependency&gt;
            &lt;groupId&gt;org.eclipse.microprofile.metrics&lt;/groupId&gt;
            &lt;artifactId&gt;microprofile-metrics-api&lt;/artifactId&gt;
            &lt;version&gt;3.0&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In DevelopersResouorce.Java we make two changes.</p>
</div>
<div class="paragraph">
<p>The addiition of the following to the imports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.metrics.annotation.Counted;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the following annotation to the getAll() definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Counted(name = "developersAll", displayName="Calls to developers getAll", description = "How many calls have been since startup.")</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve created a branch with these changes implemented.  Using the developer-ui, navigate to "Helm" and click on the extended menu option for the "eap74" helm chart. Select upgrade and replace the yaml with the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">build:
  bootableJar:
    builderImage: 'registry.access.redhat.com/ubi8/openjdk-11:latest'
  enabled: true
  env:
    - name: CUSTOM_INSTALL_DIRECTORIES
      value: extensions
  mode: s2i
  output:
    kind: ImageStreamTag
  ref: observability
  s2i:
    galleonLayers:
      - jaxrs-server
      - observability
    jdk: '11'
    jdk11:
      builderImage: registry.redhat.io/jboss-eap-7/eap-xp4-openjdk11-openshift-rhel8
      runtimeImage: registry.redhat.io/jboss-eap-7/eap-xp4-openjdk11-runtime-openshift-rhel8
    version: latest
  uri: 'https://github.com/deewhyweb/wildfly-s2i-db.git'
deploy:
  enabled: false
  route:
    enabled: true
    tls:
      enabled: true
      insecureEdgeTerminationPolicy: Redirect
      termination: edge
image:
  tag: latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will change will configure the artifact build to pull from the observability branch.</p>
</div>
<div class="paragraph">
<p>Click on upgrade.</p>
</div>
<div class="paragraph">
<p>Next, goto builds and select "eap74-build-artifacts".</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/builds.png" alt="builds">
</div>
</div>
<div class="paragraph">
<p>Click on "Actions" &#8594; "Start build"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/start-build.png" alt="start build">
</div>
</div>
<div class="paragraph">
<p>This will kick off a new artifact build which in turn will trigger a new runtime build which will eventually trigger a new deployment of the application by the operator.</p>
</div>
<div class="paragraph">
<p>Once the new version of the application is deployed goto the prometheus ui (<a href="http://127.0.0.1:9090/" class="bare">http://127.0.0.1:9090/</a>) and click on the "Graph" tab.</p>
</div>
<div class="paragraph">
<p>In the query field enter "developers" and select "application_org_wildfly_demo_DevelopersResource_developersAll_total"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-developers.png" alt="prometheus developers">
</div>
</div>
<div class="paragraph">
<p>We&#8217;re now receiving custom metrics in prometheus from our application.</p>
</div>
<div class="paragraph">
<p>Make some calls to our developers endpoint:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_mac-osx"></a>Mac OSX</p>
</li>
<li>
<p><a id="tabset1_linux"></a>Linux</p>
</li>
<li>
<p><a id="tabset1_windows"></a>Windows</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_mac-osx">
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export ROUTE_NAME=$(oc get route example-route -o jsonpath='{.spec.host}')</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_linux">
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export ROUTE_NAME=$(oc get route example-route -o jsonpath='{.spec.host}')</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_windows">
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">ROUTE_NAME=$(oc get route example-route -o jsonpath='{.spec.host}')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Test the route with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">curl https://$ROUTE_NAME/resources/developers</code></pre>
</div>
</div>
<div class="paragraph">
<p>Back in our prometheus ui click on "Execute", you should see hits registered for our custom metric.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/prometheus-custom-result.png" alt="prometheus custom result">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve seen in this section how to deploy prometheus and view default and custom metrics from our JBoss EAP deployment.
In the next section we&#8217;ll look at some possible next steps towards cloud native development for legacy Java application.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="07-content-trimming.html">Using capability trimming to reduce image size</a></span>
  <span class="next"><a href="09-whats-next.html">What&#8217;s next</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
