<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Setup :: Template Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/eap-on-openshift/06-adding-microprofile.html">
    <link rel="prev" href="05-intro-to-EAP-xp.html">
    <link rel="next" href="07-content-trimming.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/course-template">Template Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="eap-on-openshift" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-overview.html">Overview of JBoss EAP on OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#benefits">Benefits of running JBoss EAP on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#cloud-native">Cloud native development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#modernization">Modernization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#build">Building for OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#deployment">Deploying on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#clustering">Clustering JBoss EAP applications on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#autoscaling">Autoscaling applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#graceful-shutdown">Graceful shutdown</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#https">HTTPS configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-overview.html#platform-options">OpenShift platform options</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pre-reqs.html">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-mta.html">Migration Toolkit for Applications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-mta.html#installation">Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-mta.html#cloud-readiness">Perform cloud readiness check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-mta.html#the-report">Understanding the report</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-build-with-helm.html">Building JBoss EAP images with Helm</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#prereqs">Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#connectdb">Configuring JBoss EAP to connect to the postgres database</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#build">Building JBoss EAP images with Helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#chained-builds">S2I chained builds</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#deploy">Application deployment with helm</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-build-with-helm.html#testing">Testing the application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-deploy-with-operator.html">Deploying applications with the JBoss EAP Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-deploy-with-operator.html#install">Installing the JBoss EAP Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-deploy-with-operator.html#deploy">Deploy JBoss EAP application with the operator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-intro-to-EAP-xp.html">Introduction to JBoss EAP XP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-intro-to-EAP-xp.html#xponopenshift">Deploying JBoss EAP XP applications on OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-adding-microprofile.html">Adding MicroProfile support with JBoss EAP XP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#health">Adding a MicroProfile health check</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#build">Building a MicroProfile application image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#testing">Testing MicroProfile health implementation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-content-trimming.html">Using capability trimming to reduce image size</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-content-trimming.html#implement">Implement capability trimming</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-observability.html">Observability and Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-observability.html#prometheus">Deploy prometheus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-observability.html#custom">Custom metrics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-whats-next.html">What&#8217;s next</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Re-platform JBoss EAP on OpenShift</a></li>
    <li><a href="06-adding-microprofile.html">Adding MicroProfile support with JBoss EAP XP</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/deewhyweb/replatform-jboss-eap-openshift/edit/master/documentation/modules/ROOT/pages/06-adding-microprofile.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Setup</h1>
<div class="sect1">
<h2 id="_adding_microprofile_support_with_jboss_eap_xp"><a class="anchor" href="#_adding_microprofile_support_with_jboss_eap_xp"></a>Adding MicroProfile support with JBoss EAP XP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The application we have deployed depends on a Postgres database to persist data.  If the database becomes unavailable the application should detect this and stop receiving connections until it becomes avalailable again.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s test the current situation.  Go to the developer-ui and "Topology" view.</p>
</div>
<div class="paragraph">
<p>Click on the postgresql deployment, and go to the details tab.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/scale-down-pg.png" alt="scale down pg">
</div>
</div>
<div class="paragraph">
<p>Scale down the postgresql deeployment to zero pods by clicking on the <span class="image"><img src="_images/scale-icon.png" alt="scale icon"></span> icon.</p>
</div>
<div class="paragraph">
<p>Wait for the deployment to scale down to zero and then try calling making a call to our application.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll need to refresh the ROUTE_NAME variable to allow us to make calls via curl.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_mac-osx"></a>Mac OSX</p>
</li>
<li>
<p><a id="tabset1_linux"></a>Linux</p>
</li>
<li>
<p><a id="tabset1_windows"></a>Windows</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_mac-osx">
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export ROUTE_NAME=$(oc get route example-route -o jsonpath='{.spec.host}')</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_linux">
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export ROUTE_NAME=$(oc get route example-route -o jsonpath='{.spec.host}')</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_windows">
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">ROUTE_NAME=$(oc get route example-route -o jsonpath='{.spec.host}')</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Test the connection with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">curl http://$ROUTE_NAME/resources/developers</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the application is unable to connect to the database, you should receive an error like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Internal Server Error</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example demonstrates the application is still available and accepting connections.  The applicaton is attemptng to access the database and returning an error to the user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="health"><a class="anchor" href="#health"></a>Adding a MicroProfile health check</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cloud native applications should be able to avoid this situation by using accurate health check responses.</p>
</div>
<div class="paragraph">
<p>In the case of our application, we can check for a valid database connection as part of health check.</p>
</div>
<div class="paragraph">
<p>JBoss EAP XP and MicroProfile allows us to simply add a custom health check which will check the database connection.</p>
</div>
<div class="paragraph">
<p>To do this, we need to make 2 minor changes to our application source code.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Addition of DBConnectionHealthCheck.java</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.wildfly.demo;

import org.eclipse.microprofile.health.HealthCheck;
import org.eclipse.microprofile.health.HealthCheckResponse;
import org.eclipse.microprofile.health.Readiness;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

@Readiness
public class DBConnectionHealthCheck implements HealthCheck {
    private static final String HC_NAME = DBConnectionHealthCheck.class.getSimpleName();

    @PersistenceContext
    EntityManager em;

    @Override
    public HealthCheckResponse call() {
        try {
            em.createNativeQuery("SELECT 1").getSingleResult();
            return HealthCheckResponse.up(HC_NAME);
        } catch (Exception e) {
            return HealthCheckResponse.builder()
                    .name(HC_NAME)
                    .down()
                    .withData("Data Base Server is not available", e.toString())
                    .build();
        }
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Addition of the microprofile-health-api dependency to pom.xml</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">        &lt;dependency&gt;
            &lt;groupId&gt;org.eclipse.microprofile.health&lt;/groupId&gt;
            &lt;artifactId&gt;microprofile-health-api&lt;/artifactId&gt;
            &lt;version&gt;3.0&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve made these changes already in our source code reepository in the "main" branch. We&#8217;ll need to rebuild our JBoss EAP image using the EAP XP4 helm chart.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build"><a class="anchor" href="#build"></a>Building a MicroProfile application image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;re going to replace the JBoss EAP helm chart with an "EAP XP4" helm chart.  Do do this we&#8217;ll delete the existing helm chart and create a new one.</p>
</div>
<div class="paragraph">
<p>Using the developer-ui, navigate to "Helm" and click on the extended menu option for the "eap74" helm chart.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/delete-helm.png" alt="delete helm">
</div>
</div>
<div class="paragraph">
<p>Click on "Uninstall helm release" and then enter the name of the helm chart, "eap74"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/confirm-delete.png" alt="confirm delete">
</div>
</div>
<div class="paragraph">
<p>Click on uninstall.</p>
</div>
<div class="paragraph">
<p>Next, click on "+Add" and select "Helm Chart"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/select-eapxp4.png" alt="select eapxp4">
</div>
</div>
<div class="paragraph">
<p>Select "Eap Xp4" and then click on "Install Helm Chart"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/install-eapxp4.png" alt="install eapxp4">
</div>
</div>
<div class="paragraph">
<p>Change the "Release Name" field to "eap74", this will allow our existing Operator deployment to deploy this new image.</p>
</div>
<div class="paragraph">
<p>Select "yaml view" and paste the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">image:
  tag: latest
  name: eap74
build:
  enabled: true
  mode: s2i
  env:
    - name: CUSTOM_INSTALL_DIRECTORIES
      value: extensions
  output:
    kind: ImageStreamTag
  s2i:
    jdk: '11'
    jdk11:
      builderImage: registry.redhat.io/jboss-eap-7/eap-xp4-openjdk11-openshift-rhel8
      runtimeImage: registry.redhat.io/jboss-eap-7/eap-xp4-openjdk11-runtime-openshift-rhel8
    version: latest
  bootableJar:
    builderImage: 'registry.access.redhat.com/ubi8/openjdk-11:latest'
  uri: 'https://github.com/deewhyweb/wildfly-s2i-db.git'
  ref: main
deploy:
  enabled: false</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/eapxp-install-helm.png" alt="eapxp install helm">
</div>
</div>
<div class="paragraph">
<p>Click on "Install"</p>
</div>
<div class="paragraph">
<p>Once the builds are complete the JBoss EAP operator will deploy a new instance of the application, because the image stream has been updated.</p>
</div>
<div class="paragraph">
<p>Wait for the new instance to be deployed.  We can now test our new health check by scaling down the postgres database again.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing"><a class="anchor" href="#testing"></a>Testing MicroProfile health implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Go to the developer-ui and "Topology" view.</p>
</div>
<div class="paragraph">
<p>Click on the postgresql deployment, and goto the details tab.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/scale-down-pg.png" alt="scale down pg">
</div>
</div>
<div class="paragraph">
<p>Scale down the postgresql deeployment to zero pods by clicking on the <span class="image"><img src="_images/scale-icon.png" alt="scale icon"></span> icon.</p>
</div>
<div class="paragraph">
<p>Wait for the deployment to scale down to zero.</p>
</div>
<div class="paragraph">
<p>After a short interval you&#8217;ll notice the EAP deployment (example) is now showing 0 of 1 pods ready</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/eap-not-ready.png" alt="eap not ready">
</div>
</div>
<div class="paragraph">
<p>This shows the health check we&#8217;ve deployed has now detected the postgres database is unavailable.  This instance of EAP will no longer accepts connections.</p>
</div>
<div class="paragraph">
<p>If we curl the route e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">curl http://$ROUTE_NAME/resources/developers</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should get an immediate response showing the application is unailable.</p>
</div>
<div class="paragraph">
<p>If we scale the postgres database back to 1 replica, the EAP application should recover and start to accepts connections again.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we&#8217;ve seen how simple it is to implement a kubernetes compatible health check using MicroProfile health.  With some minor code changes we&#8217;ve introduce an application specific health check using cloud native development techniques.</p>
</div>
<div class="paragraph">
<p>In the next section we&#8217;ll look at how we can use EAP XP content-trimming to reduce image size and resource usage.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="05-intro-to-EAP-xp.html">Introduction to JBoss EAP XP</a></span>
  <span class="next"><a href="07-content-trimming.html">Using capability trimming to reduce image size</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
